groups:
  - name: entgroup
    rules:
      - alert: 近5分钟内容器组状态发生异常
        expr: min_over_time(sum by (cluster_name, namespace, pod, phase) (kube_pod_status_phase{namespace=~"antcloud-sofa-test-(ib645|ib1055|ib271|ib1085|pb628|ib513|bs1110)-.*", phase=~"Pending|Unknown|Failed"})[5m:1m]) > 0
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-近5分钟内容器组状态发生异常"
          env: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespace: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          ip: "{{ $labels.pod }}"
        annotations:
          summary: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-近5分钟内容器组状态发生异常"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.pod }}容器组近5分钟内状态变为{{ $labels.phase }}."

      - alert: 近5分钟内容器组连续启动失败次数过多
        expr: sum_over_time(increase(kube_pod_container_status_restarts_total{namespace=~"antcloud-sofa-test-(ib645|ib1055|ib271|ib1085|pb628|ib513|bs1110)-.*"}[1m])[5m:1m]) > 3
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-近5分钟内容器组连续启动失败次数过多"
          env: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespace: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          ip: "{{ $labels.pod }}"
        annotations:
          summary: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-近5分钟内容器组连续启动失败次数过多"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.pod }}容器组近5分钟内连续启动失败达{{ $value }}次高于阈值3次."

      - alert: 近5分钟内容器组CPU被频繁限流
        expr: rate(container_cpu_cfs_throttled_seconds_total{namespace=~"antcloud-sofa-test-(ib645|ib1055|ib271|ib1085|pb628|ib513|bs1110)-.*"}[5m]) * 100 > 25
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-近5分钟内容器组CPU被频繁限流"
          env: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespace: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          ip: "{{ $labels.pod }}"
        annotations:
          summary: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-近5分钟内容器组CPU被频繁限流"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.pod }}容器组近5分钟内被限流时间片达{{ $value }}%高于阈值25%."

      - alert: 容器组CPU使用率过高
        expr: sum(irate(container_cpu_usage_seconds_total{namespace=~"antcloud-sofa-test-(ib645|ib1055|ib271|ib1085|pb628|ib513|bs1110)-.*",container!="",container!="POD"}[5m])) by (cluster_name, namespace, pod) / sum(container_spec_cpu_quota{namespace=~"antcloud-sofa-test-(ib645|ib1055|ib271|ib1085|pb628|ib513|bs1110)-.*",container!="",container!="POD"}/100000) by (cluster_name, namespace, pod) * 100 >= 80
        for: 5m
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-容器组CPU使用率过高"
          env: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespace: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          ip: "{{ $labels.pod }}"
        annotations:
          summary: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-容器组CPU使用率过高"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.pod }}容器组CPU使用率达{{ $value }}%高于阈值80%."

      - alert: 容器组内存使用率过高
        expr: sum(irate(container_memory_working_set_bytes{namespace=~"antcloud-sofa-test-(ib645|ib1055|ib271|ib1085|pb628|ib513|bs1110)-.*",container!="",container!="POD"}[5m])) by (cluster_name, namespace, pod) / sum(container_spec_memory_limit_bytes{namespace=~"antcloud-sofa-test-(ib645|ib1055|ib271|ib1085|pb628|ib513|bs1110)-.*",container!="",container!="POD"}) by (cluster_name, namespace, pod) * 100 >= 80
        for: 5m
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-容器组内存使用率过高"
          env: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespace: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          ip: "{{ $labels.pod }}"
        annotations:
          summary: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-容器组内存使用率过高"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.pod }}容器组内存使用率达{{ $value }}%高于阈值80%."

      - alert: 工作负载可用副本数未达预期
        expr: sum(kube_deployment_spec_replicas{namespace=~"antcloud-sofa-test-(ib645|ib1055|ib271|ib1085|pb628|ib513|bs1110)-.*"}) by (cluster_name, namespace, deployment) != sum( kube_deployment_status_replicas_available{namespace=~"antcloud-sofa-test-(ib645|ib1055|ib271|ib1085|pb628|ib513|bs1110)-.*"}) by (cluster_name, namespace, deployment)
        for: 5m
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-工作负载可用副本数未达预期"
          env: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespace: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          ip: "{{ $labels.deployment }}"
        annotations:
          summary: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-工作负载可用副本数未达预期"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.deployment }}工作负载可用副本数未达预期."

      - alert: 容器组服务不可用
        expr: up{teamname="企业业务开发团队"} == 0 and up{teamname="企业业务开发团队"} offset 1m == 1
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组服务不可用"
          env: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespacel: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          sysid: "{{ $labels.sysid }}"
          ip: "{{ $labels.pod_name }}"
        annotations:
          summary: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组-服务不可用"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.sysid }}系统{{ $labels.pod_name }}容器组服务不可用."

      - alert: 服务堆内存使用率过高
        expr: sum(jvm_memory_used_bytes{teamname="企业业务开发团队", area="heap"})by(cluster_name,namespace,sysid,pod_name) / sum(jvm_memory_max_bytes{teamname="企业业务开发团队", area="heap"})by(cluster_name,namespace,sysid,pod_name) * 100 > 80
        for: 5m
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组堆内存使用率过高"
          env: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespacel: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          sysid: "{{ $labels.sysid }}"
          ip: "{{ $labels.pod_name }}"
        annotations:
          summary: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组-堆内存使用率过高"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.sysid }}系统{{ $labels.pod_name }}容器组堆内存使用率达{{ humanize $value }}%高于阈值80%."

      - alert: 近5分钟内服务拨测平均耗时过长
        expr: sum(rate(http_server_requests_seconds_sum{teamname="企业业务开发团队", uri="/statz/health"}[5m])) by (cluster_name,namespace,sysid,pod_name,uri) / sum(rate(http_server_requests_seconds_count{teamname="企业业务开发团队",uri="/statz/health"}[5m])) by (cluster_name,namespace,sysid,pod_name,uri) > 3
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-近5分钟内服务拨测平均耗时过长"
          env: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespacel: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          sysid: "{{ $labels.sysid }}"
          ip: "{{ $labels.pod_name }}"
        annotations:
          summary: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组-近5分钟内服务拨测平均耗时过长"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.sysid }}系统{{ $labels.pod_name }}容器组服务拨测接口近5分钟平均耗时达{{ humanize $value }}s高于阈值3s."

      - alert: 近5分钟内单接口错误率过高
        expr: (sum(increase(http_server_requests_seconds_count{teamname="企业业务开发团队",exception!="None"}[5m])) by (cluster_name,namespace,sysid,pod_name,uri) * 100 / sum(increase(http_server_requests_seconds_count{teamname="企业业务开发团队"}[5m])) by (cluster_name,namespace,sysid,pod_name,uri) > 30) and  (sum(increase(http_server_requests_seconds_count{teamname="企业业务开发团队"}[5m])) by (cluster_name,namespace,sysid,pod_name,uri) > 10)
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-近5分钟内单接口错误率过高"
          env: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespacel: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          sysid: "{{ $labels.sysid }}"
          ip: "{{ $labels.pod_name }}"
        annotations:
          summary: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组-近5分钟内单接口错误率过高"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.sysid }}系统{{ $labels.pod_name }}容器组{{ $labels.uri }}接口近5分钟内错误率达{{ humanize $value }}%高于阈值30%."

      - alert: 近5分钟内单接口QPS过高
        expr: sum(rate(http_server_requests_seconds_count{teamname="企业业务开发团队"}[5m])) by (cluster_name,namespace,sysid,pod_name,uri) > 1000
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-近5分钟内单接口QPS过高"
          env: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespacel: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          sysid: "{{ $labels.sysid }}"
          ip: "{{ $labels.pod_name }}"
        annotations:
          summary: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组-近5分钟内单接口QPS过高"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.sysid }}系统{{ $labels.pod_name }}容器组{{ $labels.uri }}接口近5分钟内 QPS 达{{ humanize $value }}高于阈值1000."

      - alert: 近5分钟内单接口平均耗时过长
        expr: (sum(rate(http_server_requests_seconds_sum{teamname="企业业务开发团队"}[5m])) by (cluster_name,namespace,sysid,pod_name,uri) / sum(rate(http_server_requests_seconds_count{teamname="企业业务开发团队"}[5m])) by (cluster_name,namespace,sysid,pod_name,uri) > 30) and (sum(increase(http_server_requests_seconds_count{teamname="企业业务开发团队"}[5m])) by (cluster_name,namespace,sysid,pod_name,uri) > 10)
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-近5分钟内单接口平均耗时过长"
          env: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespacel: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          sysid: "{{ $labels.sysid }}"
          ip: "{{ $labels.pod_name }}"
        annotations:
          summary: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组-近5分钟单接口平均耗时过长"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.sysid }}系统{{ $labels.pod_name }}容器组{{ $labels.uri }}接口近5分钟平均耗时达{{ humanize $value }}s高于阈值30s."

      - alert: 近5分钟内单接口P90耗时过长
        expr: (histogram_quantile(0.90, sum(rate(http_server_requests_seconds_bucket{teamname=~"企业业务开发团队"}[5m])>0) by (le,cluster_name,namespace,sysid,pod_name,uri)) > 1) and (sum(increase(http_server_requests_seconds_count{teamname="企业业务开发团队"}[5m])) by (cluster_name,namespace,sysid,pod_name,uri) > 10)
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-近5分钟内单接口P90耗时过长"
          env: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespacel: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          sysid: "{{ $labels.sysid }}"
          ip: "{{ $labels.pod_name }}"
        annotations:
          summary: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组-近5分钟单接口P90耗时过长"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.sysid }}系统{{ $labels.pod_name }}容器组{{ $labels.uri }}接口近5分钟P90耗时达{{ humanize $value }}s高于阈值1s."

      - alert: 近5分钟内单接口P99耗时过长
        expr: (histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket{teamname=~"企业业务开发团队"}[5m])>0) by (le,cluster_name,namespace,sysid,pod_name,uri)) > 3) and (sum(increase(http_server_requests_seconds_count{teamname="企业业务开发团队"}[5m])) by (cluster_name,namespace,sysid,pod_name,uri) > 10)
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-近5分钟内单接口P99耗时过长"
          env: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespacel: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          sysid: "{{ $labels.sysid }}"
          ip: "{{ $labels.pod_name }}"
        annotations:
          summary: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组-近5分钟单接口P99耗时过长"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.sysid }}系统{{ $labels.pod_name }}容器组{{ $labels.uri }}接口近5分钟P99耗时达{{ humanize $value }}s高于阈值3s."

      - alert: 全天单接口P99耗时过长
        expr: histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket{teamname=~"企业业务开发团队"}[24h])>0) by (le,cluster_name,namespace,sysid,pod_name,uri)) > 3
        labels:
          alertname: "{{ $labels.cluster_name }}集群-{{ $labels.namespace }}空间-全天单接口P99耗时过长"
          env: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组"
          severity: "3"
          cluster_name: "{{ $labels.cluster_name }}"
          namespacel: "{{ $labels.namespace }}"
          teamname: "企业业务开发团队"
          sysid: "{{ $labels.sysid }}"
          ip: "{{ $labels.pod_name }}"
        annotations:
          summary: "{{ $labels.namespace }}空间-{{ $labels.pod_name }}容器组-全天单接口P99耗时过长"
          description: "{{ $labels.cluster_name }}集群{{ $labels.namespace }}空间{{ $labels.sysid }}系统{{ $labels.pod_name }}容器组{{ $labels.uri }}接口全天P99耗时达{{ humanize $value }}s高于阈值3s."
